# 5장 서버측의 LAN 에는 무엇이 있는가?

핵심 포인트
방화벽과 캐시 서버

동작순서


---

## 1. 웹 서버의 설치 장소

<br>

### 1. 사내에 웹 서버를 설치하는 경우

- 라우터에서 직접 연결하는 경우
    * 사내에 LAN 서버를 설치하고 직접 인터넷에 액세스
    * IP 부족 이슈와 보안상의 이유로 현재는 잘 사용하지 않음
    * IP 부족 : 서버와 클라이언트에 모두 글로벌 주소를 할당해야 하는데 부족할 수 있음
    * 보안 이슈 : 인터넷에서 들어오는 패킷이 그대로 중계되는데 어플리케이션에 보안 구멍이 있다면 어플리케이션은 무방비상태가 된다.
    * 클라우드로 따지자면, 모든 서버에 EIP 를 붙이는 경우일까?

- 방화벽으로 분리하는 경우
    * 보안 이슈를 해결하기 위하여 방화벽을 통해 웹서버와 통신
    * 패킷을 검사하고 통과를 허용하는 패킷만 중계한다
    * 액세스가 허가된 어플리케이션에 보안 구멍이 있을 수 있기 때문에 완전히 위험이 없어지진 않는다.

<br>

### 2. 데이터 센터에 웹서버를 설치하는 경우

- 통신 회사의 데이터 센터에 설치하는 경우
    * 프로바이더가 운영하는 서버를 빌려쓰는 형태로 운영
    * 고속으로 액세스가 가능
    * 패킷이 인터넷 중심 부분에서 데이터 센터로 흘러가 서버에 도착한다.
    * 데이터 센터는 물리적으로 안전한 건물, 방화벽 설치 운영, 기기 가동 상태 감시, 부정 침입 감시 등의 부가 서비스를 제공하며 안정성이 높다


<br>

---

## 2. 방화벽의 원리와 동작

<br>

### 1. 패킷 필터형이 주류이다

- 방화벽은 특정 서버와 해당 서버 안의 특정 어플리케이션에 액세스 하는 패킷만 통과하고 나머지는 차단한다.

- 성능, 가격, 사용 편의성 등에 의해 패킷 필터링형 방화벽이 가장 많이 보급되어 있다.


<br>

### 2. 패킷 필터링의 조건 설정 개념

- 패킷의 헤더에 들어잇는 제어 정보를 통해 패킷 필터링 조건을 걸정한다. 이 조건에 따라서 액세스가 허가되지 않으면 해당 패킷을 차단한다.

- 패킷 헤더의 수신처 IP와 송신처 IP 로 종점과 시작점을 판단하여, 수신처가 해당 웹서버의 IP 주소와 일치하는 경우에만 패킷을 통과시킨다.

- 패킷이 들어온 후 을답 패킷을 다시 클라이언트에게 보내야 하기 때문에 웹서버에서 인터넷으로 나가는 패킷 중 송신처가 IP 가 본 서버 IP 인 경우 통과 시킨다.

<br>

### 3. 어플리케이션을 한정할 때 포트 번호를 사용한다.

- 서버에 보안에 취햑한 다양한 어플리케이션이 있는 경우, 웹 어플리ㅔ이션에 대한 패킷만 허용하고 나머지를 차단하는 방식으로 보안을 향상시킬 수 있다.


<br>

### 4. 컨트롤 비트로 접속 방향을 판단한다.

- 웹 서버에 기생하며 다른 서버에 바이러스를 감염시키는 경우가 많기 때문에 웹 서버 → 인터넷으로 가는 패킷을 차단한다. 그렇지만 패킷은 양방향 프로토콜로 소통하기 때문에 한쪽이 차단되면 소통할 수 없어진다.

- 웹 서버에서 시작되는 통신을 금지해야하는데, 그렇다고 웹 서버에서 나가는 모든 패킷을 차단할 수 없다. 프로토콜 소통이 전혀 되지 않기 때문이다.

- 액세스 방향을 판단하여 패킷을 필터링 해야한다 → TCP 헤더의 컨트롤 비트로 판단할 수 있다

- TCP 접속 시 최초 패킷만 컨트롤 비트의 SYN → 1, ACK → 0 이다.

- 웹 서버에서 인터넷으로 나가는 패킷 중 위와 같이 컨트롤 비트가 설정된 패킷을 차단하면 웹 서버에서 TCP 접속을 시작하여 인터넷으로 액세스하는 동작을 차단할 수 있다.

- 이외에도 헤더의 여러 제어 정보들을 활용해서 패킷을 차단시키고 통과시킬 수 있다.

- 통과시키는 것과 차단하는 것을 선별할 수 없는 경우도 있다.

- DNS 서버에 대한 액세스와 같이 UDP를 사용하는 경우 접속 단계 동작이 없으므로 필터링 할 수 없다.

<br>

### 5. 사내 LAN 에서 공개 서버용 LAN 으로 조건을 설정한다

- 공개 서버용 LAN과 사내 LAN 패킷 조건, 인터넷과 사내 LAN 패킷 조건도 잘 설정해야한다.

- 인터넷에서 흘러온 패킷이 무조건 공개 서버용 LAN에 유입되면 서버가 위험해진다.

- 


<br>

### 6. 밖에서 사내 LAN 으로 액세스 할 수 없다.

- 패킷 필터링형 방화벽은 주소 변환 기능도 가지고 있다. 패킷 필터링과 마찬가지로 패킷의 시작점과 종착점을 판단하여 주소변환이 필요한 경우 주소 변환을 하고 아니면 하지 않는다.

- 주소 변환을 하지 않으면 액세스할 수 없다. 적절한 주소와 포트를 찾지 못하기 때문이다. 따라서 자연스럽게 인터넷에서 사내 LAN에 접근할 수 없는 구조가 된다. (따로 패킷 조건을 설정하지 않아도 된다)

<br>

### 7. 방화벽을 통과한다.

- 방화벽은 차단하는 패킷에 대한 기록을 남긴다

- 통과 시킨 후에는 패킷을 라우터와 비슷하게 중계한다.

- 패킷 필터링은 라우터의 패킷 중계 기능 중 부가기능으로 볼 수 있는데 그 조건 설정이 복잡해지면서 전용 하드웨어나 소프트웨어가 등장한 것이다. 간단한 패킷 필터링을 사용하면 라우터를 방화벽으로 사용할 수도 있다.


<br>

### 8. 방화벽으로 막을 수 없는 공격

- 특수한 데이터에 의해 서버를 공격하는 경우, 방화벽은 헤더의 정보만으로 필터링하기 때문에 차단할 수 없다

- 이 경우 어플리케이션의 버그를 수정하거나 패킷의 내용을 조사하여 위험한 데이터를 차단하는 별도의 소프트웨어를 준비하는 것이다.

<br>

---

## 3. 복수 서버에 리퀘스트를 분배한 서버의 부하 분산

<br>

### 1. 처리 능력이 부족하면 복수 서버로 분산된다

- 대량의 패킷이 들어오게되면, 회선이 아무리 빨라도 처리능력에 한계가 온다. 이때 복수의 서버를 이용하여 한대의 서버에 몰리는 처리량을 줄이는 분산 처리를 할 수 있다.

- DNS 서버에 IP 주소를 같은 이름으로 여러개 등록하면 DNS 서버는 조회때마다 라운드 로빈으로 IP 를 응답하여 액세스를 균등하게 분산시킨다.

- 또한 복수의 페이지가 하나의 로직을 수행할 수 있는데 매 요청마다 다른 서버가 응답하면 로직이 이어지지 않을 수 있다.

- 그래서 LB 로 여러대의 서버를 연결하는 경우, 세션 클러스터링을 주의해야 한다.

<br>

### 2. 부하 분산 장치를 이용해 복수의 웹 서버로 분할된다

- DNS 서버에 LB의 IP 를 등록하면, LB에서 등록하면 LB에 연결된 서버로 분산된다.

- sticky session 을 통해 이전 요청과 같은 서버로 요청을 보내도록 한다.

- 현재는 HTTP 헤더 필드에 정보를 추가할 수 있도록 하거나 데이터가 전후 관계를 확인할 수 있는 정보를 부가하는 방법을 사용한다.

- 판단하기 위해서 웹 서버에서 정보를 유지해야하지만 그럼 웹 서버에 부담이 간다.


<br>