## STORY 01 | 케이블과 리피터, 허브 속을 신호가 흘러간다

### 1. 하나하나의 패킷이 독립된 것으로 동작한다

컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행.

패킷의 헤더에 기록된 제어 정보와 중계 장치의 내부에 있는 중계 대상을 등록한 표로 목적지를 판단하고 목적지에 가까워지도록 하여 패킷을 중계하는 형태.

중계 장치는 데이터 부분을 보지 않고 패킷을 중계

→ 모든 패킷은 아무 관련도 없는 별개의 것으로 간주하고 목적지를 향해 중계

### 2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다

송출한 신호는 그대로의 모습으로 허브에 도착하는 것이 아니라 허브에 도착할 때는 신호가 약해져 있음.

잡음의 영향까지 더해지면 매우 심각하게 변형됨. 약해진 신호가 더욱 변형되면 0과 1을 잘못 판독할 수 있음

→ 이것이 통신 오류의 원인이 됨.

### 3. ‘꼼’은 잡음을 방지하기 위한 방법이다

LAN 케이블로 사용하는 트위스트 페어 케이블(꼰 선쌍)에는 잡음의 영향을 억제하는 대책을 마련

→ 꼼 (신호선을 마주 꼬아서 잡음을 막을 수 있음)

잡음의 원인

- 케이블의 주위에서 발생하는 전자파
- 케이블의 주위에 전자파가 있으면 신호와는 다른 전류가 케이블 안에 흐름
- 신호도 전압에 의해 생기는 일종의 전류이므로 잡음에 의해 생기는 전류와 같음
- 신호와 잡음의 전류가 뒤섞여서 신호의 파형이 변형됨

전자파의 종류

- 모터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파

→ 케이블의 밖에서 오는 것으로, 선을 꼼으로써 막을 수 있음

- 같은 케이블 안의 인접한 신호선에서 누설되는 전자파

→ 신호선 안에는 신호라는 전류가 흐르므로 전류에 의해 주위에 전자파가 생기고, 이것이 다른 신호선에 대한 잡음이 됨 (크로스토크)

대책: 신호선을 마주 꼬는 것

신호선 사이의 거리를 유지하기 위해 신호선 사이에 구분판을 넣거나 전자파를 차단하기 위해 금속성의 실드라는 피복을 입힐 수도 있음

### 4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다

신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어짐.

리피터 허브는 연결된 케이블 전부에 신호를 송신

리피터 회로의 기본은 신호를 그대로 뿌리는 것이므로 잡음의 영향을 받아 변형되고, 데이터가 변화한 것 같은 신호라도 그대로 흘려버림.

- 스위칭 허브, 라우터, 서버 등에 도달하여 디지털 데이터로 변환되고 FCS를 검사하는 곳에서 데이터 변화가 판명된 후 변화된 패킷은 폐기
- 데이터가 없어지지는 않음
- 프로토콜 스택의 TCP 담당 부분이 패킷을 다시 보냄

## STORY 02 | 스위칭 허브의 패킷 중계 동작

### 1. 스위칭 허브는 주소 테이블로 중계한다

스위칭 허브의 동작

- 커넥터와 PHY(MAU) 회로는 MDI-X로 접속되어 있고, 트위스트 페어 케이블에서 신호가 들어오면 PHY(MAU) 회로의 수신 부분에 들어감
- PHY(MAU) 회로에서 케이블을 흐르는 신호의 형식부터 공통의 신호 형식으로 변환한 후 신호는 MAC 회로로 들어감
- 디지털 데이터로 변환한 후 패킷의 맨 끝에 있는 FCS를 대조하여 오류의 유무를 검사하고, 문제가 없으면 버퍼 메모리에 저장
- 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 등록되어 있는지 조사
- 수신한 패킷을 어느 포트에서 송신하면 좋을지 판단

스위칭 허브의 포트에서 MAC 회로에는 MAC 주소가 할당되어 있지 않음

스위치 회로

- 전자적으로 개폐를 제어할 수 있고, 이 전자적 개폐를 통해 신호가 흐르는 대상을 제어
- 포트 사이에 패킷을 운반할 떄, 이 회로에 패킷의 신호를 흘림
- 스위치 회로를 경유하여 송신측의 포트에 패킷을 운반하면 MAC 회로나 PHY(MAU) 회로가 송신 동작을 실행하고 케이블에 신호가 흘러감

스위칭 허브는 MAC 주소표에서 MAC 주소를 조사하고 해당하는 포트에서 신호를 송신

### 2. MAC 주소 테이블을 등록 및 갱신한다

스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행

갱신 동작

- 패킷을 수신했을 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록
- MAC 주소표에 등록한 정보는 일정 시간이 경과하면 삭제

MAC 주소표의 내용은 스위칭 허브 자체가 스스로 등록하거나 삭제하기 때문에 수동으로 등록 및 삭제할 필요 없음

### 3. 예외적인 동작

ex) 주소표에서 일치하는 행을 찾아냈을 때 주소표에 등록되어 있는 송신 포트가 패킷을 수신한 포트와 같다고 가정

스위칭 허브가 패킷을 중계하면 같은 패킷이 두 번 도착

스위칭 허브는 패킷을 수신한 포트와 송신하는 포트가 같을 경우 패킷을 중계하지 않고 폐기

수신처 MAC 주소가 브로드캐스트 주소인 경우에도 수신 포트를 제외하고 모든 포트에서 패킷을 송신

### 4. 전이중 모드에서 송신과 수신을 동시에 실행한다

스위칭 허브의 특징.. 송신과 수신을 동시에 실행할 수 있는 성질 (리피터 허브에는 X)

트위스트 페어 케이블의 신호선은 송신용과 수신용으로 나뉘어져 있으므로 송수신 도중에 신호가 충돌하지 않음. 리피터 허브를 사용하면 신호는 충돌하지 않는 셈

스위칭 허브의 전이중 모드는 송신과 수신을 동시에 진행함 (송신할 수 있는 데이터의 상한선도 높아서 성능이 좋음)

### 5. 최적의 전송 속도로 보내는 자동 조정

전이중 모드가 등장함에 따라 전이중 모드와 반이중 모드를 전환할 필요가 생김.

전이중 모드가 등장한 후 한동안 수동으로 동작 모드를 전환했지만 불편하기 때문에 나중에 동작 모들를 자동으로 전환하는 기능이 나옴

→ 자동 조정 이라고 함

- 접속한 상대가 전이중 모드를 지원하는지 검출하고 동작 모드를 자동으로 전환
- 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환

### 6. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다

스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 다른 포트는 빈 상태가 됨.

여기에서 별도의 패킷을 흘릴 수 있으며, 동시에 여러 개의 패킷을 중계할 수 있음

리피터 허브 쪽은 들어온 신호를 모든 포트에서 뿌리므로 동시에 두 개 이상의 신호가 들어오면 패킷이 충돌하기 때문에 복수의 신호를 동시에 흘릴 수 없음

→ 기기 전체에서 중계할 수 있는 패킷의 수는 스위칭 허브쪽이 리피터 허브쪽보다 많음


## STORY 03 | 라우터의 패킷 중계 동작

### 1. 라우터의 기본

- 리피터 허브나 스위칭 허브를 경유한 패킷은 라우터에 도착하고, 라우터에서 다음 라우터로 중계
- 구체적인 동작은 스위칭 허브와 다른데, 이것은 라우터의 바탕이 되는 **IP**라는 개념에 스위칭 허브의 바탕이 되는 이더넷과 다르기 때문
- 라우터는 **중계 부분**과, **포트 부분**이라는 두 부분으로 구성되어 있음
    - 중계 부분 : 패킷의 중계 대상을 판단하는 동작을 담당 - 프로토콜 스택의 IP 담당 부분
    - 포트 부분 : 패킷을 송수신하는 동작을 담당 - LAN 어댑터
- 라우터의 각 포트에는 **MAC 주소**와 **IP 주소**가 할당되어 있음

### 2. 경로표에 등록된 정보

| 수신처 | 넷마스크 | 게이트웨이 | 인터페이스 | 메트릭 |
| --- | --- | --- | --- | --- |
| 10.10.1.0 | 255.255.255.0 | --- | e2 | 1 |
| 10.10.1.101 | 255.255.255.255 | --- | e2 | 1 |
| 192.168.1.0 | 255.255.255.0 | --- | e3 | 1 |
| 192.168.1.10 | 255.255.255.255 | --- | e3 | 1 |
| 0.0.0.0 | 0.0.0.0 | 192.0.2.1 | e1 | 1 |
- 라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단
- 라우터의 테이블은 **라우팅 테이블** 또는 **경로표**라고 부름
- 라우터는 호스트 번호를 무시하고 네트워크 번호 부분만 조사

**라우터의 경로표에 경로 정보를 등록하는 방법**

- 사람이 수동으로 경로 정보를 등록/갱신
- 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록

### 3. 라우터의 패킷 수신 동작

- 이더넷의 포트 부분의 구조는 PC의 LAN 어댑터와 거의 같으므로 패킷을 수신하여 버퍼 메모리에 저장하는 부분까지의 동작도 LAN 어댑터와 거의 같음
- 신호가 커넥터 부분에 도착하면 안쪽에 있는 PHY 회로와 MAC 회로에서 신호를 디지털 데이터로 변환함. 그리고 패킷 끝부분의 FCS를 대조하여 오류의 유무를 점검하고, 정상일 경우 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사하여 해당하면 패킷을 수신 버퍼 메모리에 저장한다. 해당하지 않을 경우 패킷은 폐기

### 4. 경로표를 검색하여 출력 포트를 발견한다

- 라우터는 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기
    - MAC 헤더의 역할을 이 라우터에 패킷을 건네주는 것이기 때문에 패킷을 수신하면 역할이 끝남
- IP 헤더의 내용을 보고 패킷 중계 동작에 들어감
    - 라우팅 테이블을 조사하여 중계 대상을 선택
    - 복수의 후보가 발견될 때
        - 네트워크 번호의 비트수가 가장 긴 것
        - 메트릭 값이 작은 쪽
    - 한 개도 발견 되지 않는 경우
        - 패킷을 폐기하고, ICMP 메시지로 송신처에 이 사실을 통지
            - 스위칭 허브와 달리, 라우터가 가정하는 네트워크는 매우 크므로, 모든 포트에 패킷을 뿌리면 네트워크 혼잡을 초래할 수 있음

### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로

**해당하는 경로가 없는 경우**

- 넷마스크 0.0.0.0인 행은 '기본 경로'를 나타냄

### 6. 패킷은 유효 기한이 있다

- 패킷에는 IP 헤더에 TTL이라는 필드가 있음
- 라우터를 경유할 때 마다 -1, 즉 0이 되면 패킷을 폐기
- 패킷이 같은 장소를 순환하는 사태를 막기 위해
- 주로 64 또는 128로 설정
- 인터넷은 지구 반대편까지 액세스해도 경유하는 라우터 수가 많아야 수십 개 정도

### 7. 큰 패킷은 조각 나누기 기능으로 분할한다

- 중계하는 패킷의 크기가 출력 측의 패킷 최대 길이를 초과하면 그대로는 패킷을 송신할 수 없음
- IP 프로토콜에 규정된 조각 나누기(fragmentation)라는 방법을 사용하여 패킷을 분할하고, 패킷의 길이를 짧게 만든 후 중계
- 조각 나누기는 패킷이 만들어진 후 패킷을 분할

조각 나누기 동작

- 출력측의 MTU 조사 후, 출력 측에서 패킷을 송신할 수 있는지 조사
- 데이터 부분을 맨 앞부분부터 차례대로 잘라내고, IP 헤더를 덧붙임

### 8. 라우터의 송신 동작은 컴퓨터와 같다

- MAC 헤더를 부가
    - ARP로 IP 주소에서 MAC 주소를 조사하여 결과를 수신처 MAC 주소로 설정
- 송신패킷을 전기신호로 변환하여 포트에서 송신

### 9. 라우터와 스위칭 허브의 관계

- IP와 이더넷의 관계가 라우터와 스위칭 허브의 관계를 나타냄
- 라우터는 패킷을 운반하는 일을 스위칭 허브에 의뢰함
- 통신상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당하고, 이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당

## STORY 04 | 라우터의 부가 기능

### 1. 주소 변환으로 IP 주소를 효율적으로 이용한다

- 등장 배경
    - 주소는 고유해야 하는데 각각에 고유한 주소를 부여하면 고갈되게 되어 있음.
- 해결 방법
    - 독립된 네트워크끼리는 중복된 주소를 사용해도 문제가 안된다는 원리를 이용하여 사내 기기에는 다른 회사와 중복된 주소를 사용할 수 있도록 함
    - 사내용 주소를 private 주소, 외부에서 사용되는 고유한 주소를 global 주소로 부름.
    - private 주소는 아래 범위에 한정됨.
        - 10.0.0.0 ~ 10.255.255.255
        - 172.16.0.0 ~ 172.31.255.255
        - 192.168.0.0 ~ 192.168.255.255
    - 사내 네트워크가 인터넷과 왕래할 때는 공개용 서버에 글로벌 주소를 할당하고 인터넷과 통신하도록 함. 사내 네트워크는 인터넷과 직접 통신하지 않도록 한다 → **주소 변환**


### 2. 주소 변환의 기본 동작

- 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔 씀
- TCP 접속 동작에서 최초로 흐르는 패킷을 인터넷에 중계할 때 송신처 IP주소를 private 주소에서 global 주소로 변환 + 포트 번호 바꾸고 해당 private 주소, 포트와 global 주소 및 포트를 주소 변환 장치의 대응표에 기록
    - 여기서 global 주소는 주소 변환 장치(라우터나 방화벽)의 인터넷 측에 있는 포트에 할당된 주소
    - 포트번호는 미사용 번호를 적절하게 사용한다.
- 회신 패킷이 돌아올 때 기재되어 있는 global 주소와 포트 번호를 주소 변환 장치에서 private 주소와 기존 포트로 바꾸어 사내 네트워크에 패킷을 보낸다.
    - global 주소는 주소 변환 장치에 할당된 주소이므로 해당 장치에 패킷이 도착하게 되어있음
- 이후 패킷도 대응표에 적힌대로 변환하여 중게된다. 접속 동작이 끝나면 대응표에 정보는 삭제됨
- 인터넷에서 보면 주소변환장치가 통신 상대로 되어 있는 것

### 3. 포트 번호를 바꿔쓰는 이유

포트 번호를 바꿔쓰지 않으면 Private 주소와 global 주소가 1 대 1로 대응해서 필요함

- 접속 후 삭제하므로 동시접속 대수만큼 필요하지만 여전히 효율적이지 못함

### 4. 인터넷에서 회사로 액세스한다

- 인터넷에서 사내로 액세스 할 때는 대응표가 없다면 해당 global 주소에 대응되는 private 주소를 알 수 없음
    - 사내에서 먼저 인터넷으로 액세스 하지 않으면 연결할 수 없기 때문에 부정친입을 방지하는 효과가 있음
- 인터넷에서 회사로 액세스 하고 싶다면 사전에 대응표에 수동으로 기록해두면 됨
    - 이 경우 사내의 private 주소를 할당한 서버를 공개할 수도 있다. → 이 때는 이 global 주소를 dns 서버에 등록함


### 5. 라우터의 패킷 필터링 기능

- 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록된 내용을 조사해서 사전에 설정한 조건에 합하면 중계하거나 폐기함
    - 방화벽이나 소프트웨어는 이 원리로 부정진입을 방지
- 원리는 간단하나 조건 설정은 어려움
    - 만일 인터넷으로 들어오는 패킷을 모두 차단하면 양방향으로 주고받아야 TCP 접속 동작 등이 가능하기 때문에 사내에서 인터넷으로 흐르는 동작도 할 수 없게 됨
