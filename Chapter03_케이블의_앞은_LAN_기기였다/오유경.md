# 3장 케이블의 앞은 LAN 기기였다 

핵심 포인트
- 패킷은 LAN 어댑터를 지나 스위칭 허브, 라우터를 통해 인터넷과 연결된다

동작순서

- LAN 어댑터에서 패킷 송신

- 케이블을 통해 신호 전달

- 스위칭 허브와 라우터 등의 중계 장치를 지나 인터넷과 연결된다

---

## 1. 케이블과 리피터, 허브 속을 신호가 흘러간다

<br>

### 1. 하나하나의 패킷이 독립된 것으로 동작한다.

- 컴퓨터에서 송신된 패킷은 케이블로 흘러가 중계 장치를 경유해서 목적지에 도착한다.

- 중계 장치는 데이터의 내용을 보지 않고 헤더에 적힌 정보만 보고 중계한다.

- 내용을 보지 않으므로, 제어 정보의 내용이 패킷을 운반하는 동작에 영향을 미치지 않는다.

- 따라서 모든 패킷은 아무 관련도 없는 것으로 간주하고 목적지를 향해 중계된다.

<br>

### 2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다

- LAN 어댑터의 PHY(MAU)회로에서 전기 신호가 나가 케이블에 흘러 리피터 허브의 커넥터 부분에 도착한다.

- PHY(MAU) : Physical Layer Device 로 100mb/s 이상의 이더넷 회로의 호칭

- 송출된 신호는 케이블이 길어질 수록 신호가 약해지며, 허브에 도착할 때 약해진 신호로 잘못 판독이 되면 통신 오류의 원인이 될 수 있다.

<br>

### 3. '꼼'은 잡음을 방지하기 위한 방법이다.

- LAN 케이블로 트위스트 페어 케이블를 사용하는데, 이것은 선을 꼬게 되면서 전자파에 의한 잡음을 상쇄한다.

- 잡음은 케이블 주위에서 발생하는 전자파로 인해 발생하는데, 신호선을 마주 꼬면 잡음에서 생긴 전류가 상쇄되어 잡음에 의한 전류가 약해지는 원리를 사용한다.

<br>

### 4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다

- 신호가 리피터 허브에 도착하면 LAN 전체에 신호가 흩어진다.

- 리피터 허브에서 PHY 회로의 수신부에 도달한 신호는 리피터 회로로 들어가는데, 리피터 회로의 기본은 들어오는 신호를 리피터 허브의 커넥터 부분에 뿌리는 데 있다. 

- 신호를 수신한 기기는 맨 앞의 MAC 헤더에 쓰인 수신처 MAC 주소를 확인하고 자신이 아니면 무시한다.

- 이 다음 스위칭 허브, 라우터, 서버 등에 도착해서 디지털 데이터로 변환되고, FCS를 검사하는 곳에서 오류가 나면 패킷을 폐기한다.

<br>

---

# 2. 스위칭 허브의 패킷 중계 동작

<br>

### 1. 스위칭 허브는 주소 테이블로 중계한다

- 스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있다.

- 트위스트 페어 케이블에서 흘러온 전기 신호가 PHY(MAU)회로를 거쳐 MAC 회로로 들어온다.

- MAC 회로에서 디지털 데이터(0101로 이루어진 데이터)로 변환되고 FCS를 대조하여 오류 유무를 검사하여 문제가 없다면 메모리 버퍼에 저장한다.

- 스위치 허브의 각 포트는 PC의 LAN 어댑터와 거의 같다

- 하지만 LAN 어댑터와 다른점은 MAC 주소가 할당되어 있지 않다. 자기에게 할당된 패킷을 걸러서 받는 것이 아니라 모든 패킷을 수신하기 때문에 자신에게 부여된 MAC 주소가 필요 없다.

- 패킷을 버퍼 메모리에 저장한 후 MAC 주소표에 수신한 패킷의 수신처 MAC 주소와 일치하는 정보가 있는지 확인한다. 

- 존재한다면 해당 포트 번호로 패킷을 보낸다. 해당 포트가 송신처 포트 번호가 된다.

- 스위치 회로는 격자 모양의 배치로 교점에 스위치가 있어 독립적으로 개폐를 제어할 수 있기 때문에 신호가 중복되지 않으면 복수의 신호를 동시에 흘릴 수 있다.

- 실제로 패킷을 송신하는 PHY(MAU) 회로에서 케이블로 신호가 흘러가는데 이때는 이더넷의 규칙에 따라 아무도 송신하고 있지 않는 것을 확인하고 디지털 데이터를 신호로 변환하여 송신한다.

- LAN 어댑터와 마찬가지로 동시에 수신을 하게 되면 재밍 신호를 보낸 후 기다렸다가 재송신한다.

<br>

### 2. MAC 주소 테이블을 등록 및 갱신한다

- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신해야 한다.

- 갱신 동작
    * 패킷 수신 시 송신처 MAC 주소를 조사하여 수신한 입력 포트와 함께 주소표에 등록 (한번이라도 패킷을 송신하면 MAC 주소가 주소표에 등록됨)
    * 일정 시간이 지나면 MAC 주소표 정보는 삭제

- 잘못된 주소로 인해 패킷 통신 동작에 오류가 생기면 스위칭 허브를 리셋하여 MAC 주소를 초기화시키고 다시 주소가 등록되도록 하면 된다.

- MAC 주소표의 내용은 자동으로 스위칭 허브가 MAC 주소를 등록, 삭제, 리셋하므로 수동으로 갱신 및 등록 할 필요가 없다.

<br>

### 3. 예외적인 동작

- 스위칭 허브는 수신한 포트와 송신하는 포트가 같을 경우 패킷을 중계하지 않고 폐기한다.

- 최초이거나 삭제된 이후라서 MAC 주소표에 MAC 주소가 등록되어 있지 않은 경우, 패킷을 수신한 포트를 제외한 모든 포트에서 패킷을 송신한다. 이후 응답이 오면 해당 MAC 주소가 주소표에 등록이 되므로 그 다음 부터는 전체에게 보내지 않아도 된다.

- 수신처 MAC 주소가 브로드캐스트 주소인 경우 수신 포트를 제외하고 모든 포트에서 패킷을 송신한다.

<br>

### 4. 전이중 모드에서 송신과 수신을 동시에 실행한다

- 전이중 모드 : 송신과 수신을 동시에 실행할 수 있는 모드. 신호의 충돌을 검출하는 회로를 무효화 한다.

- 스위칭 허브는 전이중 모드로, 스위칭 허브의 포트, PHY(MAU), MAC 회로 내부가 모두 송신과 수신이 나뉘어져 있다.

<br>

### 5. 최적의 전송 속도로 보내는 자동 조정

- 자동 조정 : 동작 모드 뿐 아니라 상대의 전송 속도를 검출하여 전송 속도도 자동으로 전환하는 기능

- 접속 상대가 전이중 모드를 지원하는지 검출하여 동작 모드를 자동으로 전환하고 상대의 속도도 검출한다.

<br>


### 6. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다

- MAC 주소가 존재하는 포트 이외의 포트는 빈 포트가 되어 송신 동작을 하지 않는다.
- 이 비어있는 포트에 별도의 패킷을 흘려 동시에 여러개의 패킷을 중계할 수 있다.


---

## 3. 라우터의 패킷 중계 동작

<br>

### 1. 라우터의 기본

- 라우터의 동작은 스위치 허브와 비슷하지만 IP와 이더넷의 차이로 인한 세부 동작의 차이점이 있다.

- 라우터는 중계 부분과 포트 부분으로 나뉘어져 있다.

- 중계 부분은 다음 중계 대상을 판단하고(IP 담당부분), 포트 부분은 패킷 송수신 동작을 담당(LAN 어댑터) 한다.

- 라우터의 포트 부분에 무선 LAN용 하드웨어를 장착한 기종이라면 무선 LAN도 지원할 수 있다. 포트 부분에 통신 기술의 하드 웨어를 장착하면 다양한 통신 기술을 지원할 수 있다.

- 라우터는 먼저 포트 부분에서 패킷을 수신한다. 이 동작은 포트 부분의 통신 기술의 규칙을 따른다. 중계 부분에서 받은 패킷의 IP 패킷에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조하여 중계 대상을 판단한다. 그리고 중계 대상측의 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행한다. 여기서도 포트 부분에 의뢰하여 패킷을 송신한다.

- 스위칭 허브는 들어온 패킷을 전송하기만 하고 자신이 송신처나 수신처가 되지 않는다는 점이 라우터와 다른점이다.

<br>

### 2. 경로표에 등록된 정보

- 스위칭 허브는 MAC 주소로 중계 대상을 판단하지만 라우터는 IP 주소로 중계 대상을 판단한다.

- 중계 대상을 판단하는 표를 라우팅 테이블 혹은 경로표라고 부른다.

- 수신처의 정보에는 서브넷의 주소인 네트워크 번호만 있고 호스트는 모두 0이다. 따라서, 호스트 번호를 무시하고 네트워크 번호 부분만 조사한다.

- 주소 집약이라는 개념을 이용하면 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있다.

- 게이트웨이, 인터페이스 항목은 패킷의 중계 대상을 나타낸다. '수신처'와 '넷마스크' 항목에서 해당 행을 찾아내면 '인터페이스' 항목에 등록되어 있는 인터페이스(포트)에서 '게이트웨이' 항목에 등록되어 있는 IP 주소를 가진 라우터에 대해 패킷을 중계한다.

- 메트릭은 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타낸다. 여기 등록되어 있는 수가 작으면 목적지가 가까이 있고, 이 수가 크면 먼 것을 나타낸다.

- 숫자가 작으면 목적지가 가까운 것이다.

- 라우터는 스위치 허브와 달리 중계하는 동작과 경로표에 정보를 등록하는 동작이 분리되어 있어 중계할 때 경로표를 수정 갱신하지 않는다.

- 라우팅 테이블 등록 방법

    * 사람이 수동으로 등록/갱신
    * 라우팅 프로토콜 구조를 사용하여 라우터들기리 경로 정보를 교환하고 라우터가 스스로 경로표에 등록


<br>

### 3. 라우터의 패킷 수신 동작

- 패킷을 수신하여 버퍼 메모리에 저장하는 부분까지의 동작도 LAN 어댑터와 거의 같다.

- PHY 회로와 MAC 회로에서 신호를 디지털 데이터로 변환한다. 

- FCS를 대조하여 오류의 유무를 점검하고, 정상일 경우 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사하여 해당하면 패킷을 수신 버퍼 메모리에 저장한다. 해당하지 않을 경우 패킷은 폐기된다.


<br>

### 4. 경로표를 검색하여 출력 포트를 발견한다

- 라우터는 패킷 수신 동작이 끝나면 맨 앞의 MAC 헤더를 폐기한다. MAC 헤더의 역할은 이 라우터에 패킷을 건네주는 것이다. 패킷을 수신하면 역할이 끝나기 떄문에 MAC 헤더를 폐기하는 것이다.

- MAC 헤더의 뒤에 있는 IP 헤더의 내용을 보고 패킷 중계 동작에 들어간다.

  1. 경로표에서 중계 대상을 조사한다.

  2. 중계 대상을 조사할 때 가장 먼저 수신한 패킷의 수신처 IP 주소와 경로표의 '수신처' 항목을 조사하여 해당하는 행을 찾는다. 32비트 전부를 비교하는 게 아니라, '넷마스크' 항목에 등록된 값에서 네트워크 번호의 비트 수를 판단하여 네트워크 번호 부분만 비교한다.

  3. 해당하는 것을 찾으면 복수의 후보가 나올 수도 있다. 이 경우엔 네트워크 번호의 비트 수가 가장 긴 것을 찾는다.

  4. 네트워크 번호의 길이가 같은 것이 여러 행 존재하는 경우도 있는 데, 이 경우 메트릭 값으로 가장 값이 작은 쪽을 중계 대상으로 선택한다. 

  5. 해당하는 행이 한 개도 발견되지 않는 경우가 있을 경우, 라우터는 패킷을 폐기하고, ICMP 메시지로 송신처에 이 사실을 통지한다. 스위칭 허브와 마찬가지로 모든 포트에 패킷을 뿌릴 경우, 전 세계에 펼쳐져 있는 라우터의 네트워크를 혼잡하게 할 수도 있으므로 중계 대상이 분명하지 않은 패킷을 폐기한다.

<br>

### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로

- 넷마스크가 0.0.0.0인 경로를 기본 경로라고 하며, 일반적으로 해당 경로의 게이트웨이 항목에 인터넷으로 나가는 라우터를 등록한다


<br>

### 6. 패킷은 유효 기한이 있다

- 라우터는 중계 대상을 찾아내고 포트에서 송신하기 전에 IP헤더 필드의 TTL(Time To Live) 필드를 갱신해야한다.

- 패킷이 무한루프 도는 것을 방지하기 위하여 라우터를 경유할 때마다 위 필드 값을 1씩 감소시키고 0이 되면 유효 기한이 만료된 것으로 패킷을 폐기한다.


<br>

### 7. 큰 패킷은 조각 나누기 기능으로 분할한다

- 라우터의 포트 부분은 이더넷 뿐 아니라 다른 LAN이나 통신 회선일 수 있는데 그러면 패킷의 최대 길이가 작거나 여분의 헤더를 추가하면서 가능한 패킷의 길이가 짧아질 수 있다.

- 즉, 입력 패킷의 최대길이와 출력 포트의 최대 길이가 다른 경우가 있다.

- 이 경우 IP 프로토콜에서 fragmentation으로 패킷을 분할해 짧은 길이로 만들어서 중계한다. (패킷이 모두 만들어진 이후에 분할을 하는 것이다)

- 조각나누기의 동작
    * 출력측 MTU를 조사해서 그대로 중계할 수 있다면 바로 송신한다.
    * 아닌 경우 IP 헤더의 필드를 조사해서 분할해도 되는지 확인한다.
    * 만일 분할 불가라면 패킷을 폐기하고 ICMP를 처리한다.
    * 분할 한다면 TCP헤더부터 분할을 한다 (출력 MTU에 맞춘다) → IP 입장에서는 TCP 헤더도 데이터의 일부이다.
    * 분할한 패킷에 IP 헤더를 추가하고 분할 핵심 정보를 IP 헤더에 추가한다.

<br>

### 8. 라우터의 송신 동작은 컴퓨터와 같다

- 출력 포트에 따라서 송신 동작을 수행한다.

- 이더넷인 경우 패킷 앞에 MAC 헤더를 추가하고, 값을 설정하여 패킷을 완성시켜 전기 신호로 변환한다.
    * 수신처 MAC 주소 입력
        게이트웨이 항목이 있다면 해당 IP 주소가 다음 목적 주소이다. 없다면 최종 수신처인 IP 헤더의 IP 주소가 다음 목적 주소이다.
        IP 주소가 정해지면 ARP로 MAC주소를 조사하고 결과를 수신처 MAC주소로 설정한다.
        라우터도 ARP 캐시가 있으므로 캐시를 먼저 확인하고 없다면 ARP로 조회한다.
    * 송신처 MAC 주소 입력
        출력 포트의 MAC 주소를 입력하고 타입 필드에 0800을 설정한다.

- 전기 신호로 변환할 때 전이중 반이중 모드에 따라서 신호를 송신한다.

- 출력 포트가 이더넷이라면 송신 패킷은 스위칭 허브를 경유하여 다음 라우터에 도착한다. 이렇게 반복하여 최종 목적지에 도착한다.


<br>

### 9. 라우터와 스위칭 허브의 관계

- IP 구조는 스스로 패킷은 운반하는 수단이 없으므로 패킷을 이더넷에 의뢰하여 운반한다.

- 따라서 라우터는 스위칭 허브에 패킷을 운반하는 일을 의뢰하는 것이다.

- 패킷은 바로 다음 라우터 목적지까지만 스위칭 허브에 의뢰하여 운반되고 이것이 반복되어 최종 수신처에 전달되는 것이다.

- 이더넷 외의 무선 LAN, 통신 회선도 같은 역할이다.

- IP 는 이렇게 다양한 통신 기술에 의뢰하여 패킷 운반을 의뢰할 수 있고 따라서 인터넷이라는 거대한 네트워크 구성이 가능한 것이다.

<br>

---

## 4. 라우너틔 부가 기능

<br>

### 1. 주소 변환으로 IP 주소를 효율적으로 이용한다

- 주소는 고유해야하는데 각각에 고유한 주소를 부여하면 고갈되게 되었다. 독립된 네트워크끼리는 중복된 주소를 사용해도 문제가 안된다는 원리를 이용하여 사내 기기에는 다른 회사와 중복된 주소를 사용할 수 있도록 했다. 

- 사내용 주소를 private 주소, 외부에서 사용되는 고유한 주소를 global 주소로 부른다.

- 사내 네트워크가 인터넷과 왕래할 때는 공개용 서버에 글로벌 주소를 할당하고 인터넷과 통신하도록 한다. 사내 네트워크는 인터넷과 직접 통신하지 않도록 한다



<br>

### 2. 주소 변환의 기본 동작

- 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔쓴다.

- TCP 접속 동작에서 최초로 흐르는 패킷을 인터넷에 중계할 때 송신처 IP주소를 private 주소에서 global 주소로 변환 + 포트 번호 바꾸고 해당 private 주소, 포트와 global 주소 및 포트를 주소 변환 장치의 대응표에 기록한다.

- 여기서 global 주소는 주소 변환 장치(라우터나 방화벽)의 인터넷 측에 있는 포트에 할당된 주소이다.

- 포트번호는 미사용 번호를 적절하게 사용한다.

- 회신 패킷이 돌아올 때 기재되어 있는 global 주소와 포트 번호를 주소 변환 장치에서 private 주소와 기존 포트로 바꾸어 사내 네트워크에 패킷을 보낸다.

- global 주소는 주소 변환 장치에 할당된 주소이므로 해당 장치에 패킷이 도착하게 되어있다.

- 이후 패킷도 대응표에 적힌대로 변환하여 중게된다. 접속 동작이 끝나면 대응표에 정보는 삭제된다.

- 인터넷에서 보면 주소변환장치가 통신 상대로 되어 있는 것이다.

<br>

### 3. 포트 번호를 바꿔쓰는 이유

- 포트 번호가 아닌 주소만 바꿔 사용하는 경우 Private 주소와 global 주소가 1 대 1로 대응해서 주소가 필요하다.

- 사내 사원 수가 많은 경우 매우 비효율 적이여서 포트 번호를 바꾸는 방법으로 발전되었다.

- 하나의 글로벌 주소에 여러 프라이빗 주소로 대응시킨다.


<br>

### 4. 인터넷에서 회사로 엑세스한다

- 인터넷에서 사내로 액세스 할 때는 대응표가 없다면 해당 global 주소에 대응되는 private 주소를 알 수 없다.

- 사내에서 먼저 인터넷으로 액세스 하지 않으면 연결할 수 없기 때문에 부정침입을 방지하는 효과가 있다.

- 인터넷에서 회사로 액세스 하고 싶다면 사전에 대응표에 수동으로 기록해두면 된다.

- 이 경우 사내의 private 주소를 할당한 서버를 공개할 수도 있다. → 이 때는 이 global 주소를 dns 서버에 등록한다.

<br>

### 5. 라우터의 패킷 필터링 기능

- 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록된 내용을 조사해서 사전에 설정한 조건에 합하면 중계하거나 폐기한다.

- 방화벽이나 소프트웨어는 이 원리로 부정친입을 방지한다.

- 원리는 간단하나 조건 설정은 어렵다. 만일 인터넷으로 들어오는 패킷을 모두 차단하면 양방향으로 주고받아야 TCP 접속 동작 등이 가능하기 때문에 사내에서 인터넷으로 흐르는 동작도 할 수 없게 된다.