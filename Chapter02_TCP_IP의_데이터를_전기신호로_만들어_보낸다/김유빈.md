# STORY 01 소켓을 작성한다

## 1. 프로토콜 스택의 내부 구성

- 네트워크 어플리케이션에서 OS 에 통신을 요청하면 다음과 같은 흐름으로 처리된다.
    - 어플리케이션(Socket 라이브러리) → OS(프로토콜 스택) → 드라이버 소프트웨어 → 하드웨어
    - TCP : 브라우저나 메일 등의 일반적인 어플리케이션이 데이터를 송수신하는 경우
    - UDP : DNS 서버에 대한 조회 등의 짧은 제어용 데이터를 송수신하는 경우
- IP 프로토콜은 패킷 송수신 동작을 제어하는 부분이다.
    - 인터넷 상에서 데이터를 송수신할 때 `패킷` 이라는 작은 단위의 형태로 운반한다.
    - ICMP : 패킷을 운반할 때 발생하는 오류를 통지하거나 제어용 메시지를 통지하는 경우
    - ARP : IP 주소에 대응하는 이더넷의 MAC 주소를 조사하는 경우
- LAN 드라이버는 LAN 어댑터의 하드웨어를 제어한다.
- LAN 어댑터는 케이블에 대해 신호를 송수신하는 동작을 수행한다.

## 2. 소켓의 실체는 통신 제어용 제어 정보

- 소켓은 물리적으로 존재하는 것이 아닌 개념적인 정보를 의미한다.
    - 소켓 = 송수신하기 위한 제어 정보
    - 통신 상대의 IP, PORT, 통신 진행 상태, 응답 수신 여부, 송신 후 경과 시간 등
- 프로토콜 스택은 소켓에 기록되 제어 정보를 참조하며 진행한다.

## 3. Socket 을 호출했을 때의 동작

- 소켓을 생성한다.
    - 소켓 한 개 분량의 메모리 영역을 확보한다.
    - 초기 상태의 제어 정보를 기록한다.
- 디스크립터를 반환한다.
- 네트워크 어플리케이션은 프로토콜 스택에게 디스크립터를 전달하여 송수신동작을 수행한다.

# STORY 02 서버에 접속한다

## 1. 접속의 의미

- 클라이언트 측의 소켓에 서버 제어 정보(IP, PORT 등) 을 기록한다.
- 서버 측의 소켓에 클라이언트 제어 정보를 기록한다.
    - 프로토콜 스택이 송신하여 서버측에서 받은 정보를 기록한다.
- 데이터 송수신 시 해당 데이터를 일시적으로 저장하기 위한 버퍼 메모리를 확보한다.
- 위의 모든 동작이 접속 동작에 해당한다.

## 2. 맨 앞부분에 제어 정보를 기록한 헤더를 배치한다

- 데이터 송수신 시 전달하고자 하는 실제 데이터 가장 앞에 제어 정보를 기록하여 정보를 주고받는다. (헤더)
    - 접속, 데이터 송수신, 연결 종료 등의 동작에 필요한 정보를 포함한다.
- 서버와 클라이언트 간의 통신 과정에서 데이터를 공유하기 위해 헤더에 기록한다.
    - 통신 과정에서 전달받은 정보를 각각의 소켓에 기록하여 진행상황을 파악한다.
    - 물리적으로 떨어져있는 기기간의 정보를 주고받기 위한 과정이다.
    - 두 기기간의 스펙이 다르더라도 주고 받는 메시지를 해석하여 통신할 수 있다.

## 3. 접속 동작의 실제

- 서버에게 접속 요청을 보낸다. (SYN)
    - 어플리케이션은 Socket 라이브러리의 connect 를 호출한다.
    - 프로토콜 스택에게 송신을 의뢰하면 TCP 계층으로 제어가 이동한다.
    - 클라이언트와 서버의 포트 정보를 이용하여 TCP 헤더를 추가한다.
        - 컨트롤 비트인 SYN 을 1 로 변환한다.
    - IP 계층에서 서버와 통신 동작을 수행한다.
- 서버로부터 응답을 받으면 서버에게 정상적으로 수신했다는 요청을 보낸다. (ACK + SYN)
    - TCP 헤더를 만들어 컨트롤 비트인 ACK 를 1 로 변환한다.
    - IP 계층에서 서버와 통신 동작을 수행한다.
- 클라이언트가 서버도 정상적으로 수신했다는 응답을 확인했다는 요청을 보낸다. (ACK)
    - TCP 헤더의 SYN 이 1 이면 서버도 정상적으로 처리되었다는 의미이다.
    - 서버와 클라이언트 모두 정상적으로 동작하는 것이 확인되었으니 소켓에 제어 정보를 저장한다.
    - 서버와의 접속이 정상적으로 이루어졌다는 것을 알리기 위해 서버에게 ACK 가 1 인 TCP 헤더를 반송한다.
- 위의 과정을 거치면 클라이언트와 서버가 연결이 된 상태이다.

# STORY 03 데이터를 송수신한다

- 브라우저에서 받은 실제 데이터를 서버에 송수신하는 동작을 설명한다.

## 1. 프로토콜 스택에 HTTP 리퀘스트 메시지를 넘긴다

- Socket 라이브러리의 write 를 실행하기 전의 동작이다.
- 어플리케이션에서 받은 실데이터를 받은 프로토콜 스택은 송신용 버퍼에 저장 후 송수신한다.
    - 어플리케이션에 따라서 보내고자 하는 데이터를 한번에 보내기도, 매우 작은 단위로 보내기도 한다.
    - 버퍼를 거치지 않고 바로 통신할 경우 효율이 안좋을 수 있다.
    - 따라서 버퍼에 저장 후 적절한 패킷을 생성하여 송수신한다.
        1. 적절한 데이터의 크기를 판단하여 해당 크기를 채울 데이터가 모이면 데이터를 송신한다. (MSS)
        2. MSS 만큼의 데이터가 모이지 않더라도 일정 시간이 지나면 데이터를 송신한다.
    - 네트워크의 효율과 송신 시간을 고려하여 진행된다. 이는 OS 에 따라 다르다.
    - 어플리케이션 성격에 따라서 버퍼를 거치지 않고 바로 송신하도록 하는 설정도 부여할 수 있다. (대화형)

## 2. 데이터가 클 때는 분할하여 보낸다

- 송신하고자 하는 데이터가 클 경우에는 송신 버퍼가 MSS 의 길이가 초과하여, MSS 크기에 맞게 데이터를 분할하여 송신한다.
    - 어플리케이션 데이터 = HTTP 헤더 + 메시지 본문
- 어플리케이션 데이터를 분할하여 작은 패킷단위로 나누고, 관련 TCP, IP, MAC 등의 헤더를 추가한다.

## 3. ACK 번호를 사용하여 패킷이 도착했는지 확인한다

- TCP 통신은 데이터 송수신 시 정상적으로 처리되지 않으면 재송신하는 기능이 있기 때문에 통신이 정상적으로 이루어졌는지 확인하는 과정이 필요하다.
- 어플리케이션 데이터를 분할하여 시작점의 위치를 기록한 시퀀스 번호를 전달한다.
    - 시퀀스 초기 번호는 임의의 난수로 설정되어 있다.
        - 악의적인 공격을 대비하기 위해 임의의 난수로 설정한다.
        - 접속 과정에서 해당 값을 주고받는다.
    - 초기 번호를 기준으로 MSS 의 크기를 기준으로 다음 패킷의 시퀀스 번호가 결정된다.
- 수신측에서 시퀀스 번호를 이용하여 보내고자 하는 데이터가 모두 정상적으로 수신되었는지 조립하여 판단한다.
- 수신측에서는 수신한 데이터를 조립하여 ACK 를 마지막 바이트 + 1 의 값으로 변경하여 응답한다.
    - ACK 의 값을 확인하여 서버가 어디까지 수신했는지 알 수 있다.

## 4. 패킷 평균 왕복 시간으로 ACK 번호의 대기 시간을 조정한다

- 네트워크 문제로 통신이 지연될 경우 재송신하는 과정이 진행된다.
- 지연 시간의 기준은 적절한 값으로 설정하기 위해 대기 시간을 동적으로 관리한다.
- ACK 번호가 돌아오는 시간을 측정해두어 그때마다 적절한 대기 시간을 재설정한다.

## 5. 윈도우 제어 방식으로 효율적으로 ACK 번호를 관리한다

- 클라이언트 측에서 데이터를 송신하고 서버 측에서 이를 확인하여 ACK(수신 확인 응답) 을 하면 효율성이 떨어질 수 있다.
- 따라서, 여러번 송신 과정을 거친 후 ACK 를 보내는 방식을 취한다.
- 수신 버퍼에 수신한 데이터를 저장하여 수신 데이터를 조립하는데, 한번에 여러번 송신을 보내면 수신 버퍼가 가득차 오류가 발생한 것처럼 처리될 수 있다.
- 수신 측에서 수용할 수 있는 수신 버퍼의 잔여 크기를 클라이언트에게 공지하여 이를 보완할 수 있다. (윈도우 제어 방식)

## 6. ACK 번호와 윈도우를 합승한다

- 윈도우 사이즈를 알리는 과정은 수신 버퍼에서 데이터를 추출하여 어플리케이션에게 건네주었을 때 필요하다.
    - 송신측에서 버퍼 변화를 알 수 없는 경우에 필요하다.
- ACK 번호를 알리는 과정은 데이터를 수신했을 때 모든 과정에서 필요하다.
- 이는 모든 요청에 대해 계속해서 응답을 보내야 하므로 효율성이 떨어져, 2개 이상의 응답을 한 번에 합승하여 응답한다.
    - ACK 번호 + 윈도우 사이즈 응답
    - 여러 요청이 한번에 들어와 ACK 번호 응답이 여러 개 쌓일 경우 가장 최신 정보만 응답
    - 수신 버퍼의 변화가 여러번 이루어지는 경우 가장 최신 정보만 응답

## 7. HTTP 응답 메시지를 수신한다

- 클라이언트는 HTTP 응답 메시지를 수신하면 통신 과정이 끝난다.
- 서버에게 응답 메시지를 받기 위해 read 를 호출한다.
- 서버와 마찬가지로 클라이언트도 수신 버퍼에 저장 후 어플리케이션에게 전달된다.
